<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インタラクティブ MusicXMLカードガイド</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: Warm Neutrals with Soft Blue Accent -->
    <!-- Application Structure Plan: A single-page, vertically scrolling "interactive guide" SPA designed for parents setting up the system. It starts with a high-level visual explanation ("How it works"), followed by an interactive checklist of prerequisites. The core setup process is broken down into three user-friendly tabs (Prepare XML, Install Script, Create Shortcut) to prevent overwhelm. The "Create Shortcut" step, which is the most complex, is transformed from a static table into an interactive, step-by-step wizard. The application concludes with a simple "How to Play" guide for the child and a helpful FAQ section. This task-oriented, chunked structure enhances usability and makes the setup process feel less intimidating and more achievable. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Overall system flow. Goal: Inform. Viz/Method: HTML/Tailwind diagram. Interaction: None, static visual. Justification: Provides a quick, easy-to-grasp overview before diving into details.
        - Report Info: Required items list. Goal: Organize/Track. Viz/Method: HTML checklist. Interaction: Users can click to check off items. Justification: Makes preparation feel like a manageable task and provides a sense of accomplishment.
        - Report Info: Multi-step setup process. Goal: Organize/Guide. Viz/Method: Tabbed interface. Interaction: User clicks tabs to switch between major setup stages. Justification: Breaks the complex process into logical, digestible parts, reducing cognitive load.
        - Report Info: Scriptable code. Goal: Inform/Enable Action. Viz/Method: Pre-formatted code block. Interaction: "Copy Code" button. Justification: Drastically improves user experience by eliminating manual copying errors.
        - Report Info: Shortcut creation steps (table). Goal: Guide. Viz/Method: Interactive step-by-step wizard. Interaction: User clicks "Next/Previous" to navigate steps. Justification: Turns a dense, error-prone list of instructions into a guided, interactive experience, which is far more user-friendly.
        - Report Info: FAQ/additional context. Goal: Inform. Viz/Method: HTML <details>/<summary> accordion. Interaction: Click to expand/collapse. Justification: Provides easy access to extra information without cluttering the main interface.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Inter', sans-serif;
            background-color: #FDFBF8; /* Warm off-white */
            color: #4A4A4A;
        }
        .tab-btn.active {
            border-color: #3B82F6; /* Blue-500 */
            background-color: #EFF6FF; /* Blue-50 */
            color: #2563EB; /* Blue-600 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        details > summary {
            list-style: none;
        }
        details > summary::before {
            content: '▶';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 py-8 md:py-16 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-12 md:mb-20">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-4">MusicXMLカードでメロディーを作ろう！</h1>
            <p class="text-lg md:text-xl text-gray-600">QRコードのカードを並べて、自分だけの音楽を奏でる方法を、インタラクティブなガイドでご紹介します。</p>
        </header>

        <!-- Section 1: How it works -->
        <section id="how-it-works" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">どういう仕組み？</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4 text-center">
                    <div class="flex flex-col items-center">
                        <span class="text-5xl mb-2">🃏</span>
                        <p class="font-semibold">カードを並べる</p>
                    </div>
                    <span class="text-3xl text-gray-400 font-light">→</span>
                    <div class="flex flex-col items-center">
                        <span class="text-5xl mb-2">📱</span>
                        <p class="font-semibold">iPhoneでスキャン</p>
                    </div>
                    <span class="text-3xl text-gray-400 font-light">→</span>
                    <div class="flex flex-col items-center">
                         <div class="p-3 bg-blue-100 rounded-full mb-2">
                            <span class="text-3xl">🪄</span>
                         </div>
                        <p class="font-semibold">魔法のコードが実行</p>
                    </div>
                    <span class="text-3xl text-gray-400 font-light">→</span>
                    <div class="flex flex-col items-center">
                        <span class="text-5xl mb-2">🎼</span>
                        <p class="font-semibold">楽譜が完成！</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Prerequisites -->
        <section id="prerequisites" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">準備するもの</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <ul id="checklist" class="space-y-4">
                    <li class="flex items-center text-lg cursor-pointer">
                        <span class="check-icon mr-4 text-2xl text-gray-300">☐</span>
                        <span class="item-text">iPhone</span>
                    </li>
                    <li class="flex items-center text-lg cursor-pointer">
                        <span class="check-icon mr-4 text-2xl text-gray-300">☐</span>
                        <span class="item-text"><a href="https://apps.apple.com/jp/app/scriptable/id1405459188" target="_blank" class="text-blue-600 hover:underline">Scriptableアプリ</a>（無料）</span>
                    </li>
                    <li class="flex items-center text-lg cursor-pointer">
                        <span class="check-icon mr-4 text-2xl text-gray-300">☐</span>
                        <span class="item-text"><a href="https://github.com/" target="_blank" class="text-blue-600 hover:underline">GitHubアカウント</a>（無料）</span>
                    </li>
                    <li class="flex items-center text-lg cursor-pointer">
                        <span class="check-icon mr-4 text-2xl text-gray-300">☐</span>
                        <span class="item-text">MusicXMLファイル (各カード用)</span>
                    </li>
                    <li class="flex items-center text-lg cursor-pointer">
                        <span class="check-icon mr-4 text-2xl text-gray-300">☐</span>
                        <span class="item-text">印刷用の紙とプリンター</span>
                    </li>
                </ul>
            </div>
        </section>

        <!-- Section 3: Setup Guide -->
        <section id="setup-guide" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">セットアップガイド</h2>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <!-- Tabs -->
                <div id="tabs" class="flex border-b">
                    <button class="tab-btn flex-1 p-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-100 transition active" data-tab="1">1. 楽譜の準備</button>
                    <button class="tab-btn flex-1 p-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-100 transition" data-tab="2">2. 魔法のコード設定</button>
                    <button class="tab-btn flex-1 p-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-100 transition" data-tab="3">3. ショートカット作成</button>
                </div>
                <!-- Tab Content -->
                <div class="p-6 md:p-8">
                    <!-- Tab 1: Prepare MusicXML -->
                    <div id="tab-content-1" class="tab-content active">
                        <h3 class="text-2xl font-bold mb-4">ステップ1: 楽譜(MusicXML)の準備とQRコード化</h3>
                        <div class="prose max-w-none">
                            <p>最初に、カード1枚1枚に対応する短いMusicXMLファイルを用意し、インターネット上でアクセスできるようにします。これにはGitHub Gistが便利です。</p>
                            <ol class="list-decimal pl-5 space-y-3">
                                <li><strong>GitHub Gistにアクセス:</strong> <a href="https://gist.github.com/" target="_blank">gist.github.com</a> を開き、ログインします。</li>
                                <li><strong>MusicXMLを貼り付け:</strong> 分割したMusicXMLファイルの中身をGistのテキストエリアに貼り付け、<code>card1.musicxml</code> のようなファイル名を付けます。</li>
                                <li><strong>Gistを作成:</strong> "Create secret gist" をクリックして保存します。</li>
                                <li><strong>"Raw" URLをコピー:</strong> 作成されたGistページで、ファイルの右上にある <strong>[ Raw ]</strong> ボタンをクリックします。表示されたページのURLが、QRコードにするためのURLです。これをコピーしてください。</li>
                                <li><strong>QRコードを作成:</strong> <a href="https://qr.quel.jp/try.php" target="_blank">QRのススメ</a>などのサイトで、コピーしたURLからQRコードを生成し、印刷してカードにします。</li>
                            </ol>
                        </div>
                    </div>
                    <!-- Tab 2: Scriptable -->
                    <div id="tab-content-2" class="tab-content">
                        <h3 class="text-2xl font-bold mb-4">ステップ2: 魔法のコード(Scriptable)を設定</h3>
                         <div class="prose max-w-none mb-6">
                            <p>次に、iPhoneのScriptableアプリに、QRコードから読み取った複数のMusicXMLファイルを1つに結合するための「魔法のコード（スクリプト）」を設定します。</p>
                            <ol class="list-decimal pl-5 space-y-3">
                                <li>Scriptableアプリを開き、右上の「+」をタップして新しいスクリプトを作成します。</li>
                                <li>スクリプト名を「MergeAndPlay」などに設定します。</li>
                                <li>下のコードブロックの「コードをコピー」ボタンを押し、全文をScriptableに貼り付けます。</li>
                                <li>右上の「Done」をタップして保存すれば完了です。</li>
                            </ol>
                        </div>
                        <div>
                            <div class="bg-gray-800 rounded-lg overflow-hidden">
                                <div class="flex justify-between items-center px-4 py-2 bg-gray-700">
                                    <span class="text-gray-300 text-sm font-semibold">MergeAndPlay.js</span>
                                    <button id="copy-code-btn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md transition">コードをコピー</button>
                                </div>
                                <pre class="p-4 text-sm text-white overflow-x-auto"><code id="code-block" class="language-js">// MergeAndPlay.js for Scriptable

(async () => {
  try {
    const params = getParamsFromShortcut(args.plainTexts[0]);
    const xmlStrings = await fetchAllXML(params.urls);
    const mergedXml = mergeMeasures(xmlStrings);
    const outputPath = await saveToFile(params.output, mergedXml);
    if (config.runsInApp) {
      QuickLook.present(outputPath, true);
    } else {
      Script.setShortcutOutput(outputPath);
    }
  } catch (e) {
    console.error(e);
    let alert = new Alert();
    alert.title = "エラーが発生しました";
    alert.message = e.message;
    alert.addAction("OK");
    await alert.present();
  }
})();

function getParamsFromShortcut(inputJSON) {
  if (!inputJSON) throw new Error("ショートカットからパラメータが渡されませんでした。");
  const params = JSON.parse(inputJSON);
  if (!params.urls || !Array.isArray(params.urls) || params.urls.length === 0) {
    throw new Error("URLのリストが見つかりません。QRコードを1枚以上スキャンしてください。");
  }
  params.output = params.output || "combined.musicxml";
  return params;
}

async function fetchAllXML(urls) {
  const promises = urls.map(url => new Request(url).loadString());
  return await Promise.all(promises);
}

function mergeMeasures(xmlArray) {
  if (xmlArray.length === 0) throw new Error("結合するXMLデータが見つかりません。");
  const parser = new DOMParser();
  const baseDoc = parser.parseFromString(xmlArray[0], "application/xml");
  const basePart = baseDoc.getElementsByTagName("part")[0];
  if (!basePart) throw new Error("最初のMusicXMLファイルに<part>要素が見つかりませんでした。");

  for (let i = 1; i < xmlArray.length; i++) {
    const doc = parser.parseFromString(xmlArray[i], "application/xml");
    const measures = doc.getElementsByTagName("measure");
    for (const measure of measures) {
      basePart.appendChild(baseDoc.importNode(measure, true));
    }
  }
  return '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n' + new XMLSerializer().serializeToString(baseDoc);
}

async function saveToFile(fileName, content) {
  const fm = FileManager.local();
  const docsDir = fm.documentsDirectory();
  const path = fm.joinPath(docsDir, fileName);
  fm.writeString(path, content);
  if (fm.fileExists(path)) return path;
  throw new Error("ファイルの保存に失敗しました。");
}</code></pre>
                            </div>
                        </div>
                    </div>
                    <!-- Tab 3: Shortcut -->
                    <div id="tab-content-3" class="tab-content">
                        <h3 class="text-2xl font-bold mb-4">ステップ3: ショートカットの作成</h3>
                        <p class="mb-6">最後に、お子さんが簡単に操作できるように、iPhoneのショートカットアプリでQRコードを連続で読み取るための特別なショートカットを作成します。下のガイドに従って、アクションを順番に追加してください。</p>
                        
                        <div id="shortcut-wizard" class="border rounded-lg p-6 bg-gray-50">
                            <div id="shortcut-steps-container">
                                <!-- Steps will be injected here by JS -->
                            </div>
                            <div class="flex justify-between items-center mt-6">
                                <button id="prev-step-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded transition disabled:opacity-50" disabled>前へ</button>
                                <div id="step-indicator" class="text-sm text-gray-600"></div>
                                <button id="next-step-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition">次へ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: How to Play -->
        <section id="how-to-play" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">さあ、遊んでみよう！</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <span class="text-5xl">1️⃣</span>
                    <h3 class="text-xl font-bold my-2">カードを並べる</h3>
                    <p>好きな順番にカードを並べよう。</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <span class="text-5xl">2️⃣</span>
                    <h3 class="text-xl font-bold my-2">ショートカット実行</h3>
                    <p>作成したショートカットをタップして開始！</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <span class="text-5xl">3️⃣</span>
                    <h3 class="text-xl font-bold my-2">順番にスキャン</h3>
                    <p>「次のカードをスキャン」を選んで、カードを読み込もう。</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <span class="text-5xl">4️⃣</span>
                    <h3 class="text-xl font-bold my-2">演奏する</h3>
                    <p>「おしまい」を選ぶと楽譜が表示！共有ボタンから演奏アプリで開こう。</p>
                </div>
            </div>
        </section>
        
        <!-- Section 5: FAQ -->
        <section id="faq" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">よくある質問 (FAQ)</h2>
            <div class="space-y-4 max-w-2xl mx-auto">
                <details class="bg-white shadow-lg rounded-lg p-4 cursor-pointer">
                    <summary class="font-bold text-lg">MusicXMLって何？</summary>
                    <p class="mt-2 text-gray-700">楽譜をコンピュータで扱うための世界標準のファイル形式です。多くの楽譜作成ソフトや演奏アプリが対応しています。</p>
                </details>
                <details class="bg-white shadow-lg rounded-lg p-4 cursor-pointer">
                    <summary class="font-bold text-lg">エラーが出たときは？</summary>
                    <p class="mt-2 text-gray-700">まずはエラーメッセージを確認してください。よくある原因は、QRコードのURLが間違っている（"Raw"でないURLを使っているなど）か、Scriptableのコードが正しくコピーできていないことです。このガイドの手順をもう一度見直してみてください。</p>
                </details>
                 <details class="bg-white shadow-lg rounded-lg p-4 cursor-pointer">
                    <summary class="font-bold text-lg">Androidでもできますか？</summary>
                    <p class="mt-2 text-gray-700">このガイドはiPhoneの「ショートカット」と「Scriptable」アプリを前提としています。Androidで同様のことをするには、Taskerなどの自動化アプリを使って、似たような処理を自作する必要があります。</p>
                </details>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 mt-16">
            <p>&copy; 2024 Interactive MusicXML Guide. All Rights Reserved.</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Tab functionality
    const tabsContainer = document.getElementById('tabs');
    tabsContainer.addEventListener('click', (event) => {
        const tabBtn = event.target.closest('.tab-btn');
        if (!tabBtn) return;

        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        tabBtn.classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-content-${tabBtn.dataset.tab}`).classList.add('active');
    });

    // Copy code functionality
    const copyBtn = document.getElementById('copy-code-btn');
    const codeBlock = document.getElementById('code-block');
    copyBtn.addEventListener('click', () => {
        const codeText = codeBlock.innerText;
        navigator.clipboard.writeText(codeText).then(() => {
            copyBtn.textContent = 'コピーしました！';
            setTimeout(() => {
                copyBtn.textContent = 'コードをコピー';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                copyBtn.textContent = 'コピーしました！';
                setTimeout(() => {
                    copyBtn.textContent = 'コードをコピー';
                }, 2000);
            } catch (err) {
                copyBtn.textContent = 'コピー失敗';
            }
            document.body.removeChild(textArea);
        });
    });

    // Checklist functionality
    const checklist = document.getElementById('checklist');
    checklist.addEventListener('click', (event) => {
        const item = event.target.closest('li');
        if (!item) return;

        const icon = item.querySelector('.check-icon');
        const text = item.querySelector('.item-text');
        
        item.classList.toggle('completed');
        if (item.classList.contains('completed')) {
            icon.textContent = '✅';
            text.classList.add('line-through', 'text-gray-400');
        } else {
            icon.textContent = '☐';
            text.classList.remove('line-through', 'text-gray-400');
        }
    });
    
    // Shortcut Wizard functionality
    const shortcutSteps = [
        { title: 'アクション「テキスト」を追加', description: '最初のアクションとして「テキスト」を追加します。中身は空のままでOKです。これは後で使うURLリストの土台になります。' },
        { title: 'アクション「変数を設定」を追加', description: '次に「変数を設定」アクションを追加します。変数名を `urls` に設定し、値には先ほど追加した「テキスト」アクションのマジック変数（水色の変数）を指定します。' },
        { title: 'アクション「繰り返し」を追加', description: '「繰り返し」アクションを追加し、回数を `99` 回など、十分な数に設定します。これにより、カードを連続でスキャンできます。' },
        { title: 'アクション「メニューから選択」を追加', description: '「繰り返し」ブロックの中に「メニューから選択」を追加します。タイトルを `楽譜をスキャン` にし、選択肢として `次のカードをスキャン` と `おしまい（演奏する）` の2つを設定します。' },
        { title: 'メニュー項目1: QRスキャンを追加', description: '`次のカードをスキャン` の下に「QR/バーコードをスキャン」アクションを追加します。' },
        { title: 'メニュー項目1: リストに追加', description: 'QRスキャンの下に「リストに項目を追加」アクションを追加します。「QR/バーコード」変数を、変数 `urls` に追加するように設定します。' },
        { title: 'メニュー項目2: 繰り返しを停止', description: '`おしまい（演奏する）` の下に「繰り返しを停止」アクションを追加します。これにより、スキャンループが終了します。' },
        { title: 'アクション「テキスト」を追加 (JSON)', description: '「繰り返し」ブロックの外（下）に、新しい「テキスト」アクションを追加します。内容は `{"urls": urls, "output": "combined.musicxml"}` と入力します。`urls` の部分はマジック変数を選択してください。' },
        { title: 'アクション「Scriptable」を実行', description: '「Run Script」アクションを追加します。スクリプトに先ほど作成した「MergeAndPlay」を選択し、「引数」に最後の「テキスト」アクションのマジック変数を渡します。' },
        { title: 'アクション「値を取得」を追加', description: '「Scriptableの結果から値を取得」アクションを追加し、「ファイルパス」の値を取得するように設定します。' },
        { title: 'アクション「結果をプレビュー」を追加', description: '最後に「結果をプレビュー」アクションを追加します。入力には直前の「値を取得」アクションのマジック変数を指定します。これで完成です！' }
    ];

    let currentStep = 0;
    const stepsContainer = document.getElementById('shortcut-steps-container');
    const prevBtn = document.getElementById('prev-step-btn');
    const nextBtn = document.getElementById('next-step-btn');
    const stepIndicator = document.getElementById('step-indicator');

    function renderStep() {
        const step = shortcutSteps[currentStep];
        stepsContainer.innerHTML = `
            <div class="step-content active">
                <p class="text-sm font-bold text-blue-600 mb-2">ステップ ${currentStep + 1} / ${shortcutSteps.length}</p>
                <h4 class="text-xl font-bold mb-3">${step.title}</h4>
                <p class="text-gray-700">${step.description}</p>
            </div>
        `;
        stepIndicator.textContent = `ステップ ${currentStep + 1} / ${shortcutSteps.length}`;
        prevBtn.disabled = currentStep === 0;
        nextBtn.disabled = currentStep === shortcutSteps.length - 1;
    }

    prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            renderStep();
        }
    });

    nextBtn.addEventListener('click', () => {
        if (currentStep < shortcutSteps.length - 1) {
            currentStep++;
            renderStep();
        }
    });

    renderStep();

});
</script>

</body>
</html>
